#--------------#New Sun Cult#--------------#

increase_nsc_isolation_level = {
	if = {
		limit = {
			religion = bulwari_sun_cult
			has_dlc = "Mandate of Heaven"
		}
		if = { limit = { isolationism = 4 }
			custom_tooltip = nsc_increase_isolation_max_tt 			#already at max
		}
		else = {
			custom_tooltip = nsc_increase_isolation_tt 				#Tooltip for specific localization for each religion
			hidden_effect = { 
				add_isolationism = 1
				if = { limit = { isolationism = 4 ruler_culture = sun_elf }
					set_variable = { which = battlesWonBySunElfRuler value = 0 }
				}
				check_nsc_level_secondary_effects = yes
			}
		}
	}
}

decrease_nsc_isolation_level = {
	if = {
		limit = {
			religion = bulwari_sun_cult
			has_dlc = "Mandate of Heaven"
		}
		if = { limit = { isolationism = 1 }
			custom_tooltip = nsc_decrease_isolation_tt				#Tooltip for specific localization for each religion
			hidden_effect = {
				add_isolationism = -1
				check_nsc_level_secondary_effects = yes
			}
		}
		else = {
			custom_tooltip = nsc_increase_isolation_min_tt			#Already at min
		}
	}
}

check_nsc_level_secondary_effects = { 								#This effect can be triggered by a NSC level change, a new ruler, a vassalisation, an overlord's new ruler or a conversion
	if = {
		limit = {
			religion = bulwari_sun_cult
			has_dlc = "Mandate of Heaven"
		}
		
		if = { limit = { ruler_culture = sun_elf }
			remove_country_modifier = NSC_level_4 					#Liberty desire modifiers
			remove_country_modifier = NSC_level_3
			remove_country_modifier = NSC_level_0
		}
		
		if = { limit = { isolationism = 4 } 						# = level 5 in the loc/interface
			remove_country_modifier = NSC_level_3
			if = { 
				limit = {
					is_vassal = yes
					overlord = { ruler_culture = sun_elf }
					NOT = { ruler_culture = sun_elf }
				}
				add_country_modifier = { name = NSC_level_4 duration = -1 hidden = yes }
			}
			else = {
				remove_country_modifier = NSC_level_4
			}
		}
		else_if = { limit = { isolationism = 3 } 					# = level 4 in the loc/interface
			remove_country_modifier = NSC_level_4
			if = {
				limit = {
					is_vassal = yes
					overlord = { ruler_culture = sun_elf }
					NOT = { ruler_culture = sun_elf }
				}
				add_country_modifier = { name = NSC_level_3 duration = -1 hidden = yes }
			}
			else = {
				remove_country_modifier = NSC_level_3
			}
		}
		else_if = { limit = { isolationism = 2 } 					# = level 3 in the loc/interface
			remove_country_modifier = NSC_level_3
			country_event = { id = new_sun_cult.1 } 				#humans gets the clergy privilege back
			country_event = { id = new_sun_cult.2 } 				#lose elven mil
		}
		else_if = { limit = { isolationism = 1 } 					# = level 2 in the loc/interface
			remove_country_modifier = NSC_level_0
		}
		else_if = { limit = { isolationism = 0 } 					# = level 1 in the loc/interface
			if = {
				limit = {
					is_vassal = yes
					overlord = { ruler_culture = sun_elf }
					NOT = { ruler_culture = sun_elf }
				}
				add_country_modifier = { name = NSC_level_0 duration = -1 hidden = yes }
			}
			else = {
				remove_country_modifier = NSC_level_0
			}
		}
	}
	else = {
		remove_country_modifier = NSC_level_4
		remove_country_modifier = NSC_level_3
		remove_country_modifier = NSC_level_0
	}
}

refresh_nsc_incidents_ui = {
	if = { 
		limit = {
			religion = bulwari_sun_cult
			has_dlc = "Mandate of Heaven"
		}
		set_country_flag = updating_isolationism_window
		change_religion = cannorian_pantheon
		change_religion = bulwari_sun_cult
		clr_country_flag = updating_isolationism_window
	}
}

#For the Bulwar Under Threat incident
nsc_define_influenceable_vassals = {
	random_subject_country = {
		limit = {
			religion = bulwari_sun_cult
			NOT = { has_country_flag = influenceable_vassal_@ROOT }
			NOT = { has_country_flag = influenced_vassal_@ROOT }
		}
		set_country_flag = influenceable_vassal_@ROOT
		set_country_flag = influenceable_vassal_1_@ROOT
		save_event_target_as = influenceable_vassal_1
	}
	random_subject_country = {
		limit = {
			religion = bulwari_sun_cult
			NOT = { has_country_flag = influenceable_vassal_@ROOT }
			NOT = { has_country_flag = influenced_vassal_@ROOT }
		}
		set_country_flag = influenceable_vassal_@ROOT
		set_country_flag = influenceable_vassal_2_@ROOT
		save_event_target_as = influenceable_vassal_2
	}
	random_subject_country = {
		limit = {
			religion = bulwari_sun_cult
			NOT = { has_country_flag = influenceable_vassal_@ROOT }
			NOT = { has_country_flag = influenced_vassal_@ROOT }
		}
		set_country_flag = influenceable_vassal_@ROOT
		set_country_flag = influenceable_vassal_3_@ROOT
		save_event_target_as = influenceable_vassal_3
	}
	random_subject_country = {
		limit = {
			religion = bulwari_sun_cult
			NOT = { has_country_flag = influenceable_vassal_@ROOT }
			NOT = { has_country_flag = influenced_vassal_@ROOT }
		}
		set_country_flag = influenceable_vassal_@ROOT
		set_country_flag = influenceable_vassal_4_@ROOT
		save_event_target_as = influenceable_vassal_4
	}
	random_subject_country = {
		limit = {
			religion = bulwari_sun_cult
			NOT = { has_country_flag = influenceable_vassal_@ROOT }
			NOT = { has_country_flag = influenced_vassal_@ROOT }
		}
		set_country_flag = influenceable_vassal_@ROOT
		set_country_flag = influenceable_vassal_5_@ROOT
		save_event_target_as = influenceable_vassal_5
	}
	random_subject_country = {
		limit = {
			religion = bulwari_sun_cult
			NOT = { has_country_flag = influenceable_vassal_@ROOT }
			NOT = { has_country_flag = influenced_vassal_@ROOT }
		}
		set_country_flag = influenceable_vassal_@ROOT
		set_country_flag = influenceable_vassal_6_@ROOT
		save_event_target_as = influenceable_vassal_6
	}
}

nsc_add_influencing_vassal_modifier = {
	if = { limit = { NOT = { has_country_modifier = nsc_influencing_vassal_1 } }
		add_country_modifier = { name = nsc_influencing_vassal_1 duration = -1 }
	}
	else_if = { limit = { NOT = { has_country_modifier = nsc_influencing_vassal_2 } }
		add_country_modifier = { name = nsc_influencing_vassal_2 duration = -1 }
	}
	else_if = { limit = { NOT = { has_country_modifier = nsc_influencing_vassal_3 } }
		add_country_modifier = { name = nsc_influencing_vassal_3 duration = -1 }
	}
	else_if = { limit = { NOT = { has_country_modifier = nsc_influencing_vassal_4 } }
		add_country_modifier = { name = nsc_influencing_vassal_4 duration = -1 }
	}
	else_if = { limit = { NOT = { has_country_modifier = nsc_influencing_vassal_5 } }
		add_country_modifier = { name = nsc_influencing_vassal_5 duration = -1 }
	}
	else_if = { limit = { NOT = { has_country_modifier = nsc_influencing_vassal_6 } }
		add_country_modifier = { name = nsc_influencing_vassal_6 duration = -1 }
	}
}

nsc_remove_influencing_vassal_modifier = {
	if = { limit = { has_country_modifier = nsc_influencing_vassal_1 }
		remove_country_modifier = { name = nsc_influencing_vassal_1 duration = -1 }
	}
	else_if = { limit = { has_country_modifier = nsc_influencing_vassal_2 }
		remove_country_modifier = { name = nsc_influencing_vassal_2 duration = -1 }
	}
	else_if = { limit = { has_country_modifier = nsc_influencing_vassal_3 }
		remove_country_modifier = { name = nsc_influencing_vassal_3 duration = -1 }
	}
	else_if = { limit = { has_country_modifier = nsc_influencing_vassal_4 }
		remove_country_modifier = { name = nsc_influencing_vassal_4 duration = -1 }
	}
	else_if = { limit = { has_country_modifier = nsc_influencing_vassal_5 }
		remove_country_modifier = { name = nsc_influencing_vassal_5 duration = -1 }
	}
	else_if = { limit = { has_country_modifier = nsc_influencing_vassal_6 }
		remove_country_modifier = { name = nsc_influencing_vassal_6 duration = -1 }
	}
}

nsc_calculate_unrest_percentage = {
	set_variable = { which = TotalProvincesVar value = 0 }
	every_owned_province = {
		limit = {
			OR = {
				has_province_flag = nsc_mayor_target
				has_province_flag = nsc_merchant_target
				has_province_flag = nsc_peasant_target
			}
		}
		export_to_variable = { which = TotalUnrestVar value = unrest }
		ROOT = { change_variable = { which = TotalProvincesVar value = 1 } }
	}
	if = { limit = { check_variable = { which = TotalProvinces value = 1 } }
		divide_variable = { which = TotalUnrestVar which = TotalProvincesVar }
	}
}

nsc_calculate_war_pledge_score = {
	set_variable = { which = ScoreVar value = 0 }
	if = { limit = { tag = F21 }
		set_variable = { which = ProvincesToGetVar value = 12 } #nb of provinces in target province group x2
		nsc_incident_target_birsartanses = { limit = { owner = { religion = bulwari_sun_cult } } ROOT = { change_variable = { which = ScoreVar value = 1 } } }
		nsc_incident_target_birsartanses = { limit = { country_or_non_sovereign_subject_holds = ROOT } ROOT = { change_variable = { which = ScoreVar value = 1 } } }
		divide_variable = { which = ScoreVar which = ProvincesToGetVar } #final score in %
	}
	if = { limit = { tag = F25 }
		set_variable = { which = ProvincesToGetVar value = 16 } #nb of provinces in target province group x2
		nsc_incident_target_sareyand = { limit = { owner = { religion = bulwari_sun_cult } } ROOT = { change_variable = { which = ScoreVar value = 1 } } }
		nsc_incident_target_sareyand = { limit = { country_or_non_sovereign_subject_holds = ROOT } ROOT = { change_variable = { which = ScoreVar value = 1 } } }
		divide_variable = { which = ScoreVar which = ProvincesToGetVar } #final score in %
	}
	if = { limit = { tag = F34 }
		set_variable = { which = ProvincesToGetVar value = 12 } #nb of provinces in target province group x2
		nsc_incident_target_azka_evran = { limit = { owner = { religion = bulwari_sun_cult } } ROOT = { change_variable = { which = ScoreVar value = 1 } } }
		nsc_incident_target_azka_evran = { limit = { country_or_non_sovereign_subject_holds = ROOT } ROOT = { change_variable = { which = ScoreVar value = 1 } } }
		divide_variable = { which = ScoreVar which = ProvincesToGetVar } #final score in %
	}
	if = { limit = { tag = F37 }
		set_variable = { which = ProvincesToGetVar value = 16 } #nb of provinces in target province group x2
		nsc_incident_target_irrliam = { limit = { owner = { religion = bulwari_sun_cult } } ROOT = { change_variable = { which = ScoreVar value = 1 } } }
		nsc_incident_target_irrliam = { limit = { country_or_non_sovereign_subject_holds = ROOT } ROOT = { change_variable = { which = ScoreVar value = 1 } } }
		divide_variable = { which = ScoreVar which = ProvincesToGetVar } #final score in %
	}
	if = { limit = { tag = F37 }
		set_variable = { which = ProvincesToGetVar value = 16 } #nb of provinces in target province group x2
		nsc_incident_target_varamhar = { limit = { owner = { religion = bulwari_sun_cult } } ROOT = { change_variable = { which = ScoreVar value = 1 } } }
		nsc_incident_target_varamhar = { limit = { country_or_non_sovereign_subject_holds = ROOT } ROOT = { change_variable = { which = ScoreVar value = 1 } } }
		divide_variable = { which = ScoreVar which = ProvincesToGetVar } #final score in %
	}
}

nsc_calculate_stability_pledge_score = {
	set_variable = { which = ScoreVar value = 0 }
	if = { limit = { stability = 0 } change_variable = { which = ScoreVar value = 1 } }
	if = { limit = { stability = 1 } change_variable = { which = ScoreVar value = 2 } }
	if = { limit = { employed_advisor = { category = ADM } } change_variable = { which = ScoreVar value = 1 } }
	if = { limit = { employed_advisor = { category = DIP } } change_variable = { which = ScoreVar value = 1 } }
	if = { limit = { employed_advisor = { category = MIL } } change_variable = { which = ScoreVar value = 1 } }
	if = { limit = { is_in_deficit = no land_maintenance = 100 } change_variable = { which = ScoreVar value = 3 } }
	if = { limit = { has_estate = estate_church }
		if = { limit = { estate_loyalty = { estate = estate_church loyalty = $loyalty$ } } change_variable = { which = ScoreVar value = 1 } }
	}
	if = { limit = { has_estate = estate_nobles }
		if = { limit = { estate_loyalty = { estate = estate_nobles loyalty = $loyalty$ } } change_variable = { which = ScoreVar value = 1 } }
	}
	if = { limit = { has_estate = estate_burghers }
		if = { limit = { estate_loyalty = { estate = estate_burghers loyalty = $loyalty$ } } change_variable = { which = ScoreVar value = 1 } }
	}
	if = { limit = { has_estate = estate_mages }
		if = { limit = { estate_loyalty = { estate = estate_mages loyalty = $loyalty$ } } change_variable = { which = ScoreVar value = 1 } }
	}
	if = { limit = { has_estate = estate_adventurers }
		if = { limit = { estate_loyalty = { estate = estate_adventurers loyalty = $loyalty$ } } change_variable = { which = ScoreVar value = 1 } }
	}
	if = { limit = { all_subject_country = { NOT = { liberty_desire = 50 } } } change_variable = { which = ScoreVar value = 3 } }
	divide_variable = { which = ScoreVar value = 17 } #final score in % - max score is 17
}

#For the Taelarios incident
nsc_get_choices_ratio_effect = {
	if = { limit = { check_variable = { which = nscTotalChoicesVar value = 1 } }
		divide_variable = { which = nscChoiceAVar which = nscTotalChoicesVar }
		divide_variable = { which = nscChoiceBVar which = nscTotalChoicesVar }
		divide_variable = { which = nscChoiceCVar which = nscTotalChoicesVar }
		divide_variable = { which = nscChoiceEVar which = nscTotalChoicesVar }
		divide_variable = { which = nscChoiceFVar which = nscTotalChoicesVar }
		divide_variable = { which = nscIrrliamChoicesVar which = nscTotalChoicesVar }
		multiply_variable = { which = nscChoiceAVar value = 100 }
		multiply_variable = { which = nscChoiceBVar value = 100 }
		multiply_variable = { which = nscChoiceCVar value = 100 }
		multiply_variable = { which = nscChoiceEVar value = 100 }
		multiply_variable = { which = nscChoiceFVar value = 100 }
		multiply_variable = { which = nscIrrliamChoicesVar value = 100 }
	}
}

nsc_unity_results = {
	change_variable = { which = nscUnityVar which = nscIrrliamChoicesVar }
	if = { 
		limit = {
			check_variable = { which = nscChoiceAVar which = nscChoiceBVar }
			check_variable = { which = nscChoiceAVar which = nscChoiceCVar }
			check_variable = { which = nscChoiceAVar which = nscChoiceEVar }
			check_variable = { which = nscChoiceAVar which = nscChoiceFVar }
		}
		change_variable = { which = nscUnityVar which = nscChoiceAVar }
	}
	else_if = { 
		limit = {
			check_variable = { which = nscChoiceBVar which = nscChoiceCVar }
			check_variable = { which = nscChoiceBVar which = nscChoiceEVar }
			check_variable = { which = nscChoiceBVar which = nscChoiceFVar }
		}
		change_variable = { which = nscUnityVar which = nscChoiceBVar }
	}
	else_if = { 
		limit = {
			check_variable = { which = nscChoiceCVar which = nscChoiceEVar }
			check_variable = { which = nscChoiceCVar which = nscChoiceFVar }
		}
		change_variable = { which = nscUnityVar which = nscChoiceCVar }
	}
	else_if = { 
		limit = {
			check_variable = { which = nscChoiceEVar which = nscChoiceFVar }
		}
		change_variable = { which = nscUnityVar which = nscChoiceEVar }
	}
	else = { 
		change_variable = { which = nscUnityVar which = nscChoiceFVar }
	}
}

nsc_init_choice_variables_effect = {
	set_variable = { which = nscChoiceAVar value = 0 }
	set_variable = { which = nscChoiceBVar value = 0 }
	set_variable = { which = nscChoiceCVar value = 0 }
	set_variable = { which = nscChoiceEVar value = 0 }
	set_variable = { which = nscChoiceFVar value = 0 }
	set_variable = { which = nscIrrliamChoicesVar value = 0 }
	set_variable = { which = nscTotalChoicesVar value = 0 }
	set_variable = { which = nscTempUnityVar value = 0 }
	clr_country_flag = nsc_ratio_effect_applied
}

#For the Samartal incident
nsc_increase_tension_small_effect = {
	custom_tooltip = nsc_increase_tension_small_tt
	hidden_effect = { REB = { change_variable = { which = nscTensionsVar value = 1 } } }
}

nsc_increase_tension_medium_effect = {
	custom_tooltip = nsc_increase_tension_medium_tt
	hidden_effect = { REB = { change_variable = { which = nscTensionsVar value = 2 } } }
}

nsc_increase_tension_large_effect = {
	custom_tooltip = nsc_increase_tension_large_tt
	hidden_effect = { REB = { change_variable = { which = nscTensionsVar value = 3 } } }
}

nsc_add_investigation_ongoing_modifier = {
	if = { limit = { NOT = { has_country_modifier = nsc_investigation_ongoing_1 } }
		add_country_modifier = { name = nsc_investigation_ongoing_1 duration = -1 }
	}
	else_if = { limit = { NOT = { has_country_modifier = nsc_investigation_ongoing_2 } }
		add_country_modifier = { name = nsc_investigation_ongoing_2 duration = -1 }
	}
	else_if = { limit = { NOT = { has_country_modifier = nsc_investigation_ongoing_3 } }
		add_country_modifier = { name = nsc_investigation_ongoing_3 duration = -1 }
	}
	else_if = { limit = { NOT = { has_country_modifier = nsc_investigation_ongoing_4 } }
		add_country_modifier = { name = nsc_investigation_ongoing_4 duration = -1 }
	}
	else_if = { limit = { NOT = { has_country_modifier = nsc_investigation_ongoing_5 } }
		add_country_modifier = { name = nsc_investigation_ongoing_5 duration = -1 }
	}
}

nsc_remove_investigation_ongoing_modifier = {
	if = { limit = { has_country_modifier = nsc_investigation_ongoing_1 }
		remove_country_modifier = nsc_investigation_ongoing_1
	}
	else_if = { limit = { has_country_modifier = nsc_investigation_ongoing_2 }
		remove_country_modifier = nsc_investigation_ongoing_2
	}
	else_if = { limit = { has_country_modifier = nsc_investigation_ongoing_3 }
		remove_country_modifier = nsc_investigation_ongoing_3
	}
	else_if = { limit = { has_country_modifier = nsc_investigation_ongoing_4 }
		remove_country_modifier = nsc_investigation_ongoing_4
	}
	else_if = { limit = { has_country_modifier = nsc_investigation_ongoing_5 }
		remove_country_modifier = nsc_investigation_ongoing_5
	}
}

nsc_remove_all_investigation_ongoing_modifier = {
	remove_country_modifier = nsc_investigation_ongoing_1
	remove_country_modifier = nsc_investigation_ongoing_2
	remove_country_modifier = nsc_investigation_ongoing_3
	remove_country_modifier = nsc_investigation_ongoing_4
	remove_country_modifier = nsc_investigation_ongoing_5
}

#------------------------------------------#


increase_runelink_level = {
	if = {
		limit = {
			religion = runefather_worship
			NOT = { isolationism = 9 }
		}
		custom_tooltip = rune_increase_isolation_tt
		hidden_effect = { add_isolationism = 1 }
	}
}

decrease_runelink_level = {
	if = {
		limit = {
			religion = runefather_worship
			isolationism = 6
		}
		custom_tooltip = rune_decrease_isolation_tt
		hidden_effect = { add_isolationism = -1 }
	}
}
