abdicate_emperor_no_reelection = { #Use within emperor scope
	hidden_effect = {
		export_to_variable = { #Save emperor's religion
			which = emperor_religion
			value = religion
			who = ROOT
		}
		
		set_country_flag = emperor_religion_change #So changing religion doesn't tank prestige and give conversion zeal modifier
		if = {
			limit = { hre_religion_treaty = yes }
			
			1 = { #Use province for global variable
				set_variable = {
					which = regent_court_electors
					value = 0
				}
				set_variable = {
					which = corinite_electors
					value = 0
				}
				set_variable = {
					which = ravelian_electors
					value = 0
				}
			}
		
			every_elector = { #Count number of electors for each religion
				set_country_flag = hre_elector #Save electors
				trigger_switch = {
					on_trigger = religion
					
					regent_court = { 1 = { change_variable = { which = regent_court_electors value = 1 } } }
					corinite = { 1 = { change_variable = { which = corinite_electors value = 1 } } }
					ravelian = { 1 = { change_variable = { which = ravelian_electors value = 1 } } }
				}
			}
			
			if = { #Num Regent Court electors >= Num of other religion electors
				limit = {
					1 = {
						check_variable = {
							which = regent_court_electors
							which = corinite_electors
						}
						check_variable = {
							which = regent_court_electors
							which = ravelian_electors
						}
					}
				}
				set_hre_religion = regent_court
				set_hre_religion_locked = yes #Have to lock religion to remove religious peace
				change_religion = cannorian_pantheon #Change emperor to dummy religion to remove emperorship
			}
			else_if = { #Num Corinite electors >= Num of Ravelian electors since know > Regent Court from the IF
				limit = {
					1 = {
						check_variable = {
							which = corinite_electors
							which = ravelian_electors
						}
					}
				}
				set_hre_religion = corinite
				set_hre_religion_locked = yes
				change_religion = cannorian_pantheon
			}
			else = { #If not above Ravelian has to have most electors
				set_hre_religion = ravelian
				set_hre_religion_locked = yes
				change_religion = cannorian_pantheon
			}
			
			set_hre_religion_treaty = yes #Reapply religious peace
			
			every_known_country = { #Reapply electorship to electors removed by locking religion
				limit = {
					has_country_flag = hre_elector
				}
				clr_country_flag = hre_elector
				if = {
					limit = { is_elector = no }
					elector = yes
				}
			}
		}
		else = {
			change_religion = cannorian_pantheon
		}
		
		change_religion = variable:emperor_religion #Change former emperor back to original religion
		clr_country_flag = emperor_religion_change
	}
}

make_emperor = { #Use within scope for new emperor
	hidden_effect = {
		export_to_variable = { #Save future emperor's religion
			which = future_emperor_religion
			value = religion
			who = ROOT
		}
		if = { #Save empire's religion if not religious peace
			limit = { hre_religion_treaty = no }
			set_country_flag = hre_has_religion
			trigger_switch = {
				on_trigger = hre_religion
				
				regent_court = { set_country_flag = regent_court_empire }
				corinite = { set_country_flag = corinite_empire }
				ravelian = { set_country_flag = ravelian_empire }
			}
			if = { #Save if empire religion isn't yet locked
				limit = { hre_religion_locked = no }
				set_country_flag = hre_unlocked_religion
			}
		}
		
		set_country_flag = emperor_religion_change #So changing religion doesn't tank prestige and give conversion zeal modifier
		every_elector = { #Save electors
			set_country_flag = hre_elector
		}
		
		set_hre_religion_treaty = yes #Have to set religious peace so empire isn't dismantled
		change_religion = cannorian_pantheon #Change future emperor to dummy religion so they are only option for emperor
		elector = yes #Need someone to vote you emperor with religious peace
		set_hre_religion = cannorian_pantheon
		set_hre_religion_locked = yes
		
		emperor = {
			export_to_variable = { #Save current emperor's religion
				which = emperor_religion
				value = religion
				who = emperor
			}
			set_country_flag = emperor_religion_change
			if = {
				limit = { religion = regent_court }
				change_religion = corinite
			}
			else = {
				change_religion = regent_court
			}
			change_religion = variable:emperor_religion
			clr_country_flag = emperor_religion_change
		}
		
		set_hre_religion_treaty = yes #Have to go through religious peace so new emperor stays emperor
		change_religion = variable:future_emperor_religion
		
		if = { #Change hre religion back
			limit = { has_country_flag = hre_has_religion }
			clr_country_flag = hre_has_religion
			trigger_switch = {
				on_trigger = has_country_flag
				
				regent_court_empire = { set_hre_religion = regent_court set_hre_religion_locked = yes clr_country_flag = regent_court_empire }
				corinite_empire = { set_hre_religion = corinite set_hre_religion_locked = yes clr_country_flag = corinite_empire }
				ravelian_empire = { set_hre_religion = ravelian set_hre_religion_locked = yes clr_country_flag = ravelian_empire }
			}
			if = { #Unlock hre religion if it wasn't locked before
				limit = { has_country_flag = hre_unlocked_religion }
				set_hre_religion_locked = no
			}
		}
		
		elector = no #Remove electorship that gave vote
		every_known_country = { #Reapply electorship to electors removed by locking religion
			limit = {
				has_country_flag = hre_elector
			}
			clr_country_flag = hre_elector
			if = {
				limit = { is_elector = no }
				elector = yes
			}
		}
		clr_country_flag = emperor_religion_change
	}
}
